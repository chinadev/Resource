<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0059)http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><script src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/shares.php" charset="utf-8"></script>

<title>深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园</title>
<link type="text/css" rel="stylesheet" href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/common.css">
<link id="MainCss" type="text/css" rel="stylesheet" href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/style.css">
<link type="text/css" rel="stylesheet" href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/common2.css">
<link type="text/css" rel="stylesheet" href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/shStyle.css">
<link type="text/css" rel="stylesheet" href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/customcss.aspx">
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/yuxc/rss">
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/yuxc/rsd.xml">
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/yuxc/wlwmanifest.xml">
<script async="" type="text/javascript" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/gpt.js"></script><script type="text/javascript" async="" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/ga.js"></script><script src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">
var currentBlogApp = 'yuxc';
</script>
<script src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/common.js" type="text/javascript"></script> 
<script src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/json2.js" type="text/javascript"></script>
<script type="text/javascript" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/syntaxHighlighter.js"></script>
<script async="" type="text/javascript" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/google_ads_gpt.js"></script><script type="text/javascript" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/osd.js"></script></head>
<body><link href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/jiathis_counter.css" rel="stylesheet" type="text/css"><script src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/jiathis.php" charset="utf-8"></script><link href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/jiathis_share.css" rel="stylesheet" type="text/css"><iframe frameborder="0" style="position: absolute; display: none; opacity: 0;"></iframe><div class="jiathis_style" style="position: absolute; z-index: 1000000000; display: none; top: 50%; left: 50%; overflow: auto;"></div><div class="jiathis_style" style="position: absolute; z-index: 1000000000; display: none; overflow: auto;"></div><iframe frameborder="0" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/jiathis_utility.htm" style="display: none;"></iframe>
<a name="top"></a>
<!--PageBeginHtml Block Begin-->
<script type="text/javascript">
window.onload = show;
function show(){
 var h3 = document.getElementsByTagName('H3');
 var len = h3.length;
 var currH3;
 for(var i = 0 ; i < len ; i++){
    currH3 = h3[i].innerText;
    if(currH3 == '公告'){
        h3[i].innerText='牛皮糖的Blog';
       }
  }
}
</script>
<!--PageBeginHtml Block End-->

<div id="home">
<div id="header">
	<div id="blogTitle">
		
<!--done-->
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/yuxc/">牛皮糖的旅程</a></div>
<div class="subtitle">Brick walls,they let us prove how badly we want things.    
            --------摘自Randy Pausch的《最后一课》</div>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li id="nav_sitehome"><a id="MyLinks1_HomeLink" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
<li id="nav_myhome"><a id="MyLinks1_MyHomeLink" class="menu" href="http://www.cnblogs.com/yuxc/">首页</a></li>
<li id="nav_q"><a class="menu" href="http://q.cnblogs.com/">博问</a></li>
<li id="nav_ing"><a class="menu" href="http://home.cnblogs.com/ing/">闪存</a></li>
<li id="nav_newpost"></li>
<li id="nav_contact"><a id="MyLinks1_ContactLink" class="menu" rel="nofollow" href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone">联系</a></li>
<li id="nav_rss">
<!----></li>
<li id="nav_admin"><a id="MyLinks1_Admin" class="menu" rel="nofollow" href="http://www.cnblogs.com/yuxc/admin/EditPosts.aspx">管理</a></li>
</ul>

		<div class="blogStats">
			
			
<!--done-->
随笔-215&nbsp;
文章-0&nbsp;
评论-165&nbsp;

			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
	
<!--done-->
<div id="topics">
	<div class="post">
		<h1 class="postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园.htm">深入云存储系统Swift核心组件：Ring实现原理剖析</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">简介</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><strong><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 14pt;">OpenStack</span></span></span></strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">是一个美国国家航空航天局和</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Rackspace</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">合作研发的开源云计算项目，并成为</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Apache</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">下的一个重要开源项目，目前已经发展到了</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">180</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">家公司参与其中。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><a style="border-bottom-style: none;" href="http://www.openstack.org/projects/storage/"><span style="text-underline: none;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">OpenStack Object Storage</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; text-underline: none;" lang="EN-US"><span lang="EN-US"><span style="font-family: 宋体;"><span style="font-size: 12pt;">（</span></span></span></span><strong><span style="mso-bidi-font-size: 10.0pt; text-underline: none;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 14pt;">Swift</span></span></span></strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; text-underline: none;" lang="EN-US"><span lang="EN-US"><span style="font-family: 宋体;"><span style="font-size: 12pt;">）</span></span></span></span></a></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="color: #000000; font-family: 宋体;">是</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><a style="border-bottom-style: none;" href="http://www.openstack.org/"><span style="text-underline: none;"><span style="font-family: &#39;Times New Roman&#39;;">OpenStack</span></span></a></span><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">开源云计算项目的子项目之一。</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Swift</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的目的是使用普通硬件来构建冗余的、可扩展的分布式对象存储集群，存储容量可达</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">PB</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">级。</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">OpenStack Object Storage </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">最初由</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> Rackspace </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">采用</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Python</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">语言开发，并于</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> 2010 </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">年</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> 7 </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">月贡献给</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> OpenStack ,</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">作为该开源项目的一部分。它的目的是用于托管</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> Rackspace</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> Cloud Files service </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">，原始项目代号是</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> swift</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">，所以沿用至今。</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">在分布式对象存储中的一个关键问题是数据该如何存放。</span></span></span><span style="font-size: 12pt;"><strong><span style="font-size: 18pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span></strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">是</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Swift</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">中最重要的组件，用于记录存储对象与物理位置间映射关系。在涉及查询</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">account</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">container</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">object</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">信息时就需要查询集群的</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">信息。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-font-weight: bold; mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 14.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">先来看一下</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-font-weight: bold; mso-bidi-font-size: 14.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Swift</span></span><span style="mso-bidi-font-weight: bold; mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 14.0pt;"><span style="font-family: 宋体;">文档中关于</span></span><span style="mso-bidi-font-weight: bold; mso-bidi-font-size: 14.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span></span><span style="mso-bidi-font-weight: bold; mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 14.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的描述：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US">Ring</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">用来确定数据驻留在集群中的位置。有单独对应于</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Account</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">数据库、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">container</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">数据库和单个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">object</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">Ring</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">中每个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">在集群中都</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">(</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">默认</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">)</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">有</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">。每个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的位置由</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">来维护</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">,</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">并存储在映射中。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">Ring</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">使用</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的概念来保证数据的隔离。每个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">都确保放在了不同的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">中。一个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">可以是一个硬盘，一个服务器，一个机架，一个交换机，甚至是一个数据中心</span></span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">............</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">.......</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">在上述</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的特性描述中提到了</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">使用</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">device</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">和</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">等等来维护数据和磁盘间的映射信息。那么在</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span><span style="font-family: 宋体;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;">的背后采用什么算法，使用了什么机制来保证数据的安全、高效和可扩展呢？这些概念对于数据存储带来了什么好处？</span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;">本文逐步深入探讨了</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Swift</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">如何通过</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">组件来实现冗余的、可扩展的目的。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: -18pt; margin: 0cm 0cm 0pt 18pt; word-break: normal; mso-list: l0 level1 lfo1;" align="justify"><span><span style="color: #000000;"><span style="mso-list: ignore;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;"><strong>1.</strong></span><span style="line-height: normal;"><span style="font-size: 7pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><strong><span style="font-family: 宋体;"><span style="font-size: 12pt;">普通</span></span><span style="font-size: 12pt;"><span style="font-family: &#39;Times New Roman&#39;;">Hash</span></span><span style="font-family: 宋体;"><span style="font-size: 12pt;">算法与场景分析</span></span></strong></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><strong style="mso-bidi-font-weight: normal;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">先来看一个简单的例子假设我们手里有</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">台存储服务器（以下简称</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">），打算用于图片文件存储，为了使服务器的负载均衡，需要把对象均匀地映射到每台服务器上，通常会使用哈希算法来实现，计算步骤如下：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">1.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">计算</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">object</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">hash</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">值</span></span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">Key</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">2.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">计算</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Key mod N</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">值</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">有</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">个存储节点，将</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Key</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">模</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">得到的余数就是该</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Key</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">对应的值需要存放的节点。比如，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">是</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，那么值为</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">0</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">4</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Key</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">需要分别存放在</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">0</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">0</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">和</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">0</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">号节点上。如果哈希算法是均匀的，数据就会被平均分配到两个节点中。如果每个数据的访问量比较平均，负载也会被平均分配到两个节点上。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 0cm; word-break: normal; text-align: justify;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">但是，当数据量和访问量进一步增加，两个节点无法满足需求的时候，需要增加一个节点来服务客户端的请求。这时，</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">变成了</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，映射关系变成了Key mod (N+1)，因此，上述哈希值为</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">4</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的数据需要重新分配（</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2-&gt;server 2</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3 -&gt; server 0</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">4 -&gt; server 1</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">）。如果数据量很大的话，那么数据量的迁移工作将会非常大。当</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">已经很大，从</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">加入一个节点变成</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N+1</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">个节点的过程，会导致整个哈希环的重新分配，这个过程几乎是无法容忍的，</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">几乎全部的数据都要重新移动一遍。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp; &nbsp; &nbsp; &nbsp;我们举例说明，</span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">假设有</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">100</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node的集群</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，将</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">10<sup>7</sup></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">项数据使用</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">md5 hash</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">算法分配到每个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">中，</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Python</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">代码如下：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from hashlib import md5<br>from struct import unpack_from<br><br>NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="color: #f6f3e8; font-family: Consolas;">node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #99968b;"># This just pulls part of the hash out as an integer</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><span style="font-family: Consolas;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(data_id).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br>&nbsp;&nbsp;&nbsp; node_id = hsh % NODE_COUNT<br>&nbsp;&nbsp;&nbsp; node_counts[node_id] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT</span><br></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br>max_count = max(node_counts)<br>over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (max_count, over)<br>min_count = min(node_counts)<br>under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (min_count, under)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100000</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100695</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.69</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">99073</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.93</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">分布结果如下所示：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">　　　　</span></span></span></span></p>
<table class="MsoNormalTable" style="border-collapse: collapse; word-break: normal; mso-table-layout-alt: fixed; mso-border-alt: solid windowtext .5pt; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-insideh: .5pt solid windowtext; mso-border-insidev: .5pt solid windowtext;" border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; padding-top: 0cm; mso-border-alt: solid windowtext .5pt; border: windowtext 1pt solid;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">名称</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: windowtext 1pt solid; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">数据项数量</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: windowtext 1pt solid; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">百分比值</span></span></span></p>















</td>















</tr>
<tr>
<td style="border-bottom: windowtext 1pt solid; border-left: windowtext 1pt solid; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">数据项均值</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">100000</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">0%</span></span></span></p>















</td>















</tr>
<tr>
<td style="border-bottom: windowtext 1pt solid; border-left: windowtext 1pt solid; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">最多数据项节点</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">100695</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">+0.69%</span></span></span></p>















</td>















</tr>
<tr style="mso-yfti-lastrow: yes;">
<td style="border-bottom: windowtext 1pt solid; border-left: windowtext 1pt solid; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">最少数据项节点</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">99073</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">-0.93%</span></span></span></p>















</td>















</tr>















</tbody>















</table>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">从数据分布上来看拥有最多</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">/</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">最少数据项的节点没有超出平均值的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。现在假设增加一个节点提供负载能力，不过得重新分配数据项到新的节点上，代码如下：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from hashlib import md5<br>from struct import unpack_from<span style="mso-spacerun: yes;">&nbsp; </span><br><br>NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">NEW_NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">101</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="color: #f6f3e8; font-family: Consolas;">moved_ids = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br>&nbsp;&nbsp;&nbsp; node_id = hsh % NODE_COUNT<br>&nbsp;&nbsp;&nbsp; new_node_id = hsh % NEW_NODE_COUNT<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_ids += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_ids / DATA_ID_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_ids, percent_moved)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">9900989</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">99.01</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span><a style="border-bottom-style: none;" name="OLE_LINK10"></a><a style="border-bottom-style: none;" name="OLE_LINK9"></a><a style="border-bottom-style: none;" name="OLE_LINK8"></a><a style="border-bottom-style: none;" name="OLE_LINK7"></a></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">通过计算我们发现，为了提高集群</span></span></span></span></span></span></span><span style="font-size: 12pt;"><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1%</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的存储能力，我们需要移动</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">9900989</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">个数据项，也就是</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">99.01%</span></span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据项！显然，这种算法严重地影响了系统的性能和可扩展性。</span></span></span></span></span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307151784.gif"><img style="background-image: none; margin-top: 0px; margin-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; border-style: initial; border-color: initial; display: block; margin-left: auto; margin-right: auto; border-width: 0px;" title="clip_image002[4]" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/201206212307151261.gif" alt="clip_image002[4]" width="354" height="207" border="0"></a></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">增加1%</span></span></span><span style="font-size: 12pt;"><span><span style="font-family: 宋体;">的存储能力</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">=</span></span><span><span style="font-family: 宋体;">移动</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">99%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据？</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">这种亏本生意显然做不得，那么怎么办呢？一致性哈希算法就是为了解决这个问题而来。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: -18pt; margin: 0cm 0cm 0pt 18pt; word-break: normal; mso-list: l0 level1 lfo1;" align="justify"><a style="border-bottom-style: none;" name="OLE_LINK12"></a><a style="border-bottom-style: none;" name="OLE_LINK11"></a><span style="mso-bookmark: ole_link12;"><span><span style="mso-list: ignore;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;"><strong>2.</strong></span><span style="line-height: normal;"><span style="font-size: 7pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><strong><span style="font-family: 宋体;"><span style="font-size: 12pt;">一致性哈希算法</span></span></strong></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">一致性哈希算法是由</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">D. Darger、E. Lehman和T. Leighton&nbsp;</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">等人于</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1997</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">年在论文</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Consistent Hashing and Random Trees:Distributed Caching Protocols for Relieving Hot Spots On the World Wide Web</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">首次提出，目的主要是为了解决分布式网络中的热点问题。在其论文中，提出了一致性哈希算法并给出了衡量一个哈希算法的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">4</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个指标：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<blockquote>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">平衡性</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">(Balance)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">平衡性是指</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Hash</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-size: 12pt;"><span style="font-family: 宋体;">的结果能够尽可能分布均匀，充分利用所有缓存空间</span><a style="border-bottom-style: none;" name="2_2"></a></span><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">单调性</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">(Monotonicity)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲加入到系统中。哈希的结果应能够保证原有已分配的内容可以被映射到新的缓冲中去，而不会被映射到旧的缓冲集合中的其他缓冲区。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">分散性</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">(Spread)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">分散性定义了分布式环境中，不同终端通过</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Hash</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">过程将内容映射至缓存上时，因可见缓存不同，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Hash</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">结果不一致，相同的内容被映射至不同的缓冲区。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">负载</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">(Load)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">负载是对分散性要求的另一个纬度。既然不同的终端可以将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。</span></span></span></span></p>











</blockquote>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">Swift</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">使用该算法的主要目的是在改变集群的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">数量时（增加/删除服务器），能够尽可能少地改变已存在</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">key</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">和</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射关系，以满足单调性。一致性哈希一般两种思路：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt 18pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">1.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">迁移为主要特点</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">(swift</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">初期采用</span></span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">)</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt 18pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">2.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">引入虚结点，减少移动为特点</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">(swift</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">现采用</span></span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">)</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">具体步骤如下：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">1.&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;">首先求出每个节点(机器名或者是IP地址)的哈希值，并将其分配到一个</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">圆环区间上（这里取0-2^32）。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">2.&nbsp;&nbsp;&nbsp; </span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">求出需要存储对象的哈希值，也将其分配到这个圆环上。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span><span style="font-size: 12pt;">&nbsp; &nbsp; &nbsp; &nbsp;</span></span><span style="font-size: 12pt;">3.&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span><span style="font-family: 宋体;">从对象映射到的位置开始顺时针查找，将对象保存到找到的第一个节点上。</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;">其中这个从哈希到位置映射的圆环，我们就可以理解为何使用术语“</span></span><strong style="mso-bidi-font-weight: normal;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span></strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;">”来表示了。哈希环空间上的分布如图</span></span><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">所示：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307157706.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image004[4]" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/201206212307167739.jpg" alt="clip_image004[4]" width="382" height="289" border="0"></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1 </span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">哈希环空间</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 10.5pt; color: #000000;">&nbsp;&nbsp;</span></span></span><span style="font-size: 12pt;"><span><span style="font-family: 宋体;">假设在这个环形哈希空间中，</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Cache5</span></span><span><span style="font-family: 宋体;">被映射在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Cache3</span></span><span><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Cache4</span></span><span><span style="font-family: 宋体;">之间，那么受影响的将仅是沿</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Cache5</span></span><span><span style="font-family: 宋体;">逆时针遍历直到下一个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Cache</span></span><span><span style="font-family: 宋体;">（</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Cache3</span></span><span><span style="font-family: 宋体;">）之间的对象（它们本来映射到</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Cache4</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">上）。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307169408.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image006[4]" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/201206212307165853.jpg" alt="clip_image006[4]" width="413" height="329" border="0"></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2 </span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">一致性哈希算法的数据移动</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 10.5pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;<span style="mso-tab-count: 1;">&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">现在，使用该算法在集群中增加一个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，同时要保证每个节点的数据项数量均衡，代码如下所示，其中</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node_range_starts</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">表示每个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据项的开始位置。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from bisect import bisect_left<br>from hashlib import md5<br>from struct import unpack_from <br><br>NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">NEW_NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">101</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">node_range_starts = []</span><br></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id in xrange(NODE_COUNT):<br>&nbsp;&nbsp;&nbsp; node_range_starts.append(DATA_ID_COUNT /<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NODE_COUNT * node_id)<br>new_node_range_starts = []</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> new_node_id in xrange(NEW_NODE_COUNT):<br>&nbsp;&nbsp;&nbsp; new_node_range_starts.append(DATA_ID_COUNT /<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NEW_NODE_COUNT * new_node_id)<br>moved_ids = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br>&nbsp;&nbsp;&nbsp; node_id = bisect_left(node_range_starts,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hsh % DATA_ID_COUNT) % NODE_COUNT<br>&nbsp;&nbsp;&nbsp; new_node_id = bisect_left(new_node_range_starts,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hsh % DATA_ID_COUNT) % NEW_NODE_COUNT<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_ids += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_ids / DATA_ID_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_ids, percent_moved)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">4901707</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">49.02</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">结果虽然比之前好了些，但是提高</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1%</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的性能与移动</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">50%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据仍不理想。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307173411.gif"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image008[4]" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/201206212309356435.gif" alt="clip_image008[4]" width="298" height="184" border="0"></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">增加</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1%</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">能力</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">=</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">移动</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">50%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">数据？</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">引入虚拟节点</span></span></span></strong><strong><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">(Partition)</span></span></span></strong></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">考虑到哈希算法在</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">较少的情况下，改变node数会带来巨大的数据迁移</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">。为了解决这种情况，一致性哈希引入了“虚拟节点”的概念：</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">&nbsp;</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">“虚拟节点”是实际节点在环形空间的复制品，一个实际节点对应了若干个“虚拟节点”，</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">“虚拟节点”在哈希空间中以哈希值排列。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309364516.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image010[4]" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/201206212309364898.jpg" alt="clip_image010[4]" width="459" height="325" border="0"></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3 </span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">虚拟节点</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">引入了“虚拟节点”后，映射关系就从【</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">object---&gt;node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">】转换成了【</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">object---&gt;virtual node---&gt; node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">】。查询</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">object</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">所在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射关系如下图所示。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309376044.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image012[4]" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/201206212309386110.jpg" alt="clip_image012[4]" width="547" height="300" border="0"></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 12.0pt;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span style="mso-bidi-font-size: 12.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">4 </span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-font-size: 12.0pt;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">对象、虚结点、节点间的映射关系</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="mso-bidi-font-size: 12.0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 10.5pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">对</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">100</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">细分为</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1000</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，使用</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode_range_starts</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">来指定</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的开始范围，</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode2node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">表示</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">到</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的指派，然后增加一个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，完成</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的重新分配，并计算所移动的数据项：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from bisect import bisect_left<br>from hashlib import md5<br>from struct import unpack_from<br><br>NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">VNODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">vnode_range_starts = []<br>vnode2node = []</span><br></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id in xrange(VNODE_COUNT):<br>&nbsp;&nbsp;&nbsp; vnode_range_starts.append(DATA_ID_COUNT /<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VNODE_COUNT * vnode_id)<br>&nbsp;&nbsp;&nbsp; vnode2node.append(vnode_id % NODE_COUNT)<br>new_vnode2node = list(vnode2node)<br>new_node_id = NODE_COUNT<br>NEW_NODE_COUNT = NODE_COUNT + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">vnodes_to_reassign = VNODE_COUNT / NEW_NODE_COUNT</span><br></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_reassign &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_to_take_from in xrange(NODE_COUNT):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id, node_id in enumerate(new_vnode2node):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id == node_to_take_from:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new_vnode2node[vnode_id] = new_node_id<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vnodes_to_reassign -= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_reassign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_reassign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">moved_ids = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br>&nbsp;&nbsp;&nbsp; vnode_id = bisect_left(vnode_range_starts,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hsh % DATA_ID_COUNT) % VNODE_COUNT<br>&nbsp;&nbsp;&nbsp; node_id = vnode2node[vnode_id]<br>&nbsp;&nbsp;&nbsp; new_node_id = new_vnode2node[vnode_id]<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_ids += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_ids / DATA_ID_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_ids, percent_moved)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">90108</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.90</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">结果显示，仅移动了</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">0.9%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据。与前面相比，整个集群的性能大大提高了。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309385587.gif"><img style="background-image: none; padding-left: 0px; padding-right: 0px; padding-top: 0px; border-style: initial; border-color: initial; display: block; margin-left: auto; margin-right: auto; border-width: 0px;" title="clip_image014[4]" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/201206212309385063.gif" alt="clip_image014[4]" width="255" height="216" border="0"></a></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">增加</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1%</span></span><span><span style="font-family: 宋体;">的能力</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">=</span></span><span><span style="font-family: 宋体;">移动</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">0.9%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">数据</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　固化虚节点到数据项的映射</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">由于虚节点个数在集群的整个生命周期中是不会变化的，它与数据项的映射关系不会发生变化，改变的仅是</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">与</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射关系，所以需对以上代码进行优化。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from struct import unpack_from<br>from hashlib import md5<br>from time import time<br><br>NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">VNODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">begin = time()<br>vnode2node = []</span><br></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id in xrange(VNODE_COUNT):<br>&nbsp;&nbsp;&nbsp; vnode2node.append(vnode_id % NODE_COUNT)<br>new_vnode2node = list(vnode2node)<br>new_node_id = NODE_COUNT<br>vnodes_to_assign = VNODE_COUNT / (NODE_COUNT + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_assign &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_to_take_from in xrange(NODE_COUNT):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id, node_id in enumerate(vnode2node):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id == node_to_take_from:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vnode2node[vnode_id] = new_node_id<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vnodes_to_assign -= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_assign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_assign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">moved_id = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br>&nbsp;&nbsp;&nbsp; vnode_id = hsh % VNODE_COUNT</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #99968b;">#(1)</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; node_id = vnode2node[vnode_id]<br>&nbsp;&nbsp;&nbsp; new_node_id = new_vnode2node[vnode_id]<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_id += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_id / DATA_ID_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_id, percent_moved)</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d seconds pass ...'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (time() - begin)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">90108</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.90</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　预设合理的虚结点数</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">现在已构建好了一致性哈希</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的原型。但是存在一个问题，以上例子中，</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1000</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个虚结点对应着</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">100</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个结点，结点变动时，虚结点就需要重新分配到结点。当</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">100</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个结点扩展到</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1001</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个结点时，此时至少有一个结点分配不到虚结点，那么就需要再增加虚结点数，而虚结点是与数据项对应的哈希关系，如果改变了虚节点数，那么就需要重新分配所有的数据项，这将导致移动大量的数据。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">所以在设置虚结点数的时候，需要对系统预期的规模做充分考虑，假如集群的规模不会超过</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">6000</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个结点，那么可以将虚结点数设置为结点数的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">100</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">倍。这样，变动任意一个结点的负载仅影响</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1%</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的数据项。此时有</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">6</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">百万个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">数，使用</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2bytes</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">来存储结点数</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">(0~65535)</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">。基本的内存占用是</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">6*10<sup>6</sup>*2bytes=12Mb</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">，对于服务器来说完全可以承受。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">在此，引入了</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个概念：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">swift</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">中，为了区分</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，将</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">vnode</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">称为</span></span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: &#39;Times New Roman&#39;;">partition</span></span></strong></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　位操作代替取模操作</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">此外，在计算机中使用位操作来确定</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的位置比取模更快。所以，在此引入了</span></span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: &#39;Times New Roman&#39;;">partition power</span></span></strong></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的概念。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">继续改进</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的代码，设有</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">65536</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node(2^16)</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，有</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">128</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">（</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2^7</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">）倍个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">数</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">(2^23)</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">。由于</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">MD5</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">码是</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">32</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">位的，使用</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">PARTITION_SHIFT(</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">等于</span></span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="color: #000000; font-family: &#39;Times New Roman&#39;;">32- </span><a style="border-bottom-style: none;" name="OLE_LINK2"></a><a style="border-bottom-style: none;" name="OLE_LINK1"></a><span style="mso-bookmark: ole_link2;"><span style="font-family: &#39;Times New Roman&#39;;">PARTITION_POWER</span></span><span style="color: #000000; font-family: &#39;Times New Roman&#39;;">)</span></span><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">将数据项的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">MD5</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">哈希值映射到</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2^23</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的空间中。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br>from hashlib import md5<br>from struct import unpack_from<br><br>PARTITION_POWER = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">23</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_SHIFT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">32</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - PARTITION_POWER<br>NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">65536</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="color: #f6f3e8; font-family: Consolas;">part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'H'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER):<br>&nbsp;&nbsp;&nbsp; part2node.append(part % NODE_COUNT)<br>node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; PARTITION_SHIFT<br>&nbsp;&nbsp;&nbsp; node_id = part2node[part]<br>&nbsp;&nbsp;&nbsp; node_counts[node_id] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT</span><br></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br>max_count = max(node_counts)<br>over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (max_count, over)<br>min_count = min(node_counts)<br>under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (min_count, under)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1525</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1683</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">10.36</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1360</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">10.82</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">数据不均衡的原因在于数据项相对于</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">数太小了</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">(10^8</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">对</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2^23)</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">，若数据项越多，分布越均衡。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">保证数据安全，引入</span></span></span></strong><strong><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">replica</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><strong><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;</span></span></span></strong></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">到目前为止，在集群中的数据在本地节点上只有一份，节点一旦发生故障就可能会造成数据的永久性丢失。因此，</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Swift</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">中引入</span></span></span></span><span style="font-size: 12pt;"><strong><span lang="EN-US"><span style="color: #ff0000; font-family: &#39;Times New Roman&#39;;">replica</span></span></strong><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的概念使用冗余副本来保证数据的安全。</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的默认值为</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，其理论依据主要来源于</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">NWR</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">策略。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">NWR</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">是一种在分布式存储系统中用于控制一致性级别的一种策略。在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Amazon</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Dynamo</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">云存储系统中，就应用</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">NWR</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">来控制一致性。每个字母的涵义如下：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="color: #000000;"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">N</span></span></span></span><span style="font-size: 12pt;"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">：同一份数据的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的份数</span></span></span><span lang="EN-US"><br><span style="font-family: &#39;Times New Roman&#39;;"><span style="color: #000000;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>W</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="color: #000000; font-family: 宋体;">：是更新一个数据对象的时候需要确保成功更新的份数</span></span><span lang="EN-US"><br><span style="font-family: &#39;Times New Roman&#39;;"><span style="color: #000000;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>R</span></span></span><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">：</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">读取一个数据需要读取的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Replica</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的份数</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">在分布式系统中，数据的单点是不允许存在的。即线上正常存在的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">数量是</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的情况是非常危险的，因为一旦这个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">再次错误，就可能发生数据的永久性错误。假如我们把</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">设置成为</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，那么，只要有一个存储节点发生损坏，就会有单点的存在。所以</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">必须大于</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">。</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">约高，系统的维护和整体成本就越高。工业界通常把</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">N</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">设置为</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">因此，在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的代码中引入</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，数量设置为</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，其中</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"> node_ids</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">记录的是</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">3</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">存放的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node id</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">。</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">part2node[part]</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">是根据</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition id </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">找到对应的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node id</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br>from hashlib import md5<br>from struct import unpack_from<br><br>REPLICAS = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">3</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_POWER = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_SHIFT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">32</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - PARTITION_POWER<br>PARTITION_MAX = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER - </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">256</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="color: #f6f3e8; font-family: Consolas;">part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'H'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER):<br>&nbsp;&nbsp;&nbsp; part2node.append(part % NODE_COUNT)<br>node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; PARTITION_SHIFT<br>&nbsp;&nbsp;&nbsp; node_ids = [part2node[part]]<br>&nbsp;&nbsp;&nbsp; node_counts[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> replica in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, REPLICAS):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part2node[part] in node_ids:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part &gt; PARTITION_MAX:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids.append(part2node[part])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts[node_ids[-</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT * REPLICAS</span><br></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br>max_count = max(node_counts)<br>over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (max_count, over)<br>min_count = min(node_counts)<br>under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (min_count, under)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">117186</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">118133</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.81</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">116093</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.93</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">&nbsp; &nbsp; 结果如上，由于使用了</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">256</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，分布约有</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的波动，比较均匀了。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">但是存在有</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个问题：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　随机分配映射</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">首先</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">part2node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">是基于顺序分配的，对于给定的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，它所有</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">copies</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">均在另两个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">上，若某个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">频繁宕机，与它相应的两个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">上的数据项需要频繁复制。解决方法是随机分配</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">到</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">　　分区容忍性和引入</span></span></span></strong><strong><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">zone</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">其次是当前的集群不满足</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">CAP</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">原理中的分区容忍性（</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Partition Tolerance</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">）。</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Gilbert </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Lynch</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;"><span style="color: #000000; font-family: 宋体;">将</span><a style="border-bottom-style: none;" name="OLE_LINK6"></a><a style="border-bottom-style: none;" name="OLE_LINK5"></a><span style="mso-bookmark: ole_link6;"><span style="font-family: 宋体;">分区容忍性</span></span></span><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">定义如下：</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="color: #555555;"><span style="color: #000000;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt;" lang="EN-US"><span style="font-family: Georgia;"><span style="font-size: 10.5pt;">No set of failures less than total network failure is allowed to cause the system to respond incorrectly</span></span></span></span><span style="color: #000000;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-ascii-font-family: georgia; mso-hansi-font-family: georgia; mso-bidi-font-size: 10.5pt;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">。</span></span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: Georgia;"><span style="font-size: 10.5pt; color: #555555;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">翻译一下，就是除了全部网络节点发生故障以外，所有子节点集合的故障都不允许导致整个系统的响应故障。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">现在为止，这些</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">都在一个机架上，一旦发生断电，网络故障，那么将丧失这一性质。因此就需要一种机制对机器的物理位置进行隔离。所以引入了</span></span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: &#39;Times New Roman&#39;;">zone</span></span></strong></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的概念。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">代码中引入</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone_count</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，把这些</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">分割到</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">16</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">中去。其中</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">不能放在同一个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">上或同一个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">内。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br>from hashlib import md5<br>from random import shuffle<br>from struct import unpack_from<br><br>REPLICAS = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">3</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_POWER = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_SHIFT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">32</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - PARTITION_POWER<br>PARTITION_MAX = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER - </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">256</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">ZONE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">node2zone = []</span><br></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> len(node2zone) &lt; NODE_COUNT:<br>&nbsp;&nbsp;&nbsp; zone = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> zone &lt; ZONE_COUNT and len(node2zone) &lt; NODE_COUNT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node2zone.append(zone)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'H'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER):<br>&nbsp;&nbsp;&nbsp; part2node.append(part % NODE_COUNT)<br>shuffle(part2node)<br>node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT<br>zone_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * ZONE_COUNT</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; PARTITION_SHIFT<br>&nbsp;&nbsp;&nbsp; node_ids = [part2node[part]]<br>&nbsp;&nbsp;&nbsp; zones = [node2zone[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]]]<br>&nbsp;&nbsp;&nbsp; node_counts[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; zone_counts[zones[</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> replica in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, REPLICAS):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part2node[part] in node_ids and \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node2zone[part2node[part]] in zones:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part &gt; PARTITION_MAX:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids.append(part2node[part])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zones.append(node2zone[node_ids[-</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts[node_ids[-</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_counts[zones[-</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT * REPLICAS</span><br></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br>max_count = max(node_counts)<br>over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (max_count, over)<br>min_count = min(node_counts)<br>under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (min_count, under)<br>desired_count = DATA_ID_COUNT / ZONE_COUNT * REPLICAS</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per zone'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br>max_count = max(zone_counts)<br>over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids in one zone, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (max_count, over)<br>min_count = min(zone_counts)<br>under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids in one zone, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br>&nbsp;&nbsp;&nbsp; (min_count, under)</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">117186</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">118782</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.36</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">115632</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.33</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% under</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1875000</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per zone</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1878533</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.19</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1869070</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.32</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">到目前为止，</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的基本功能都已经有了：一致性哈希</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition power</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">。目前还差</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">weight</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">以及将以上代码改写为类封装成</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">module</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">weight</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="color: #000000; font-family: 宋体;"><span style="font-size: 12pt;">引入</span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: &#39;Times New Roman&#39;;">weight</span></span></strong><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的概念，目的是“能者多劳”：解决未来添加存储能力更大的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">时，使得可以分配到更多的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">。例如，</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2T </span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">容量的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">数为</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1T</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的两倍。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的构建中，加入了</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">weight</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">属性。本例中</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">weight</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">简单地取</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">2</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">两个值，根据每个结点在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">weight</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">和中的比例分配所需</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">数。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br>from hashlib import md5<br>from random import shuffle<br>from struct import unpack_from<br>from time import time</span></span><span style="font-size: 10.5pt;"><br><br></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">class</span></span></span></span><span style="font-size: 10.5pt;"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> Ring(object):<br><br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">__init__</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(self, nodes, part2node, replicas):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.nodes = nodes<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.part2node = part2node<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.replicas = replicas<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; partition_power = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power &lt; len(part2node):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; partition_power += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> len(part2node) != </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">raise</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> Exception(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">"part2node's length is not an "</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">"exact power of 2"</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.partition_shift = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">32</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - partition_power<br><br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">get_nodes</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(self, data_id):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(data_id).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; self.partition_shift<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids = [self.part2node[part]]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zones = [self.nodes[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]]]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> replica in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, self.replicas):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> self.part2node[part] in node_ids and \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.nodes[self.part2node[part]] in zones:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part &gt;= len(self.part2node):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids.append(self.part2node[part])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zones.append(self.nodes[node_ids[-</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">return</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> [self.nodes[n] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in node_ids]</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">build_ring</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(nodes, partition_power, replicas):<br>&nbsp;&nbsp;&nbsp; begin = time()<br>&nbsp;&nbsp;&nbsp; parts = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power<br>&nbsp;&nbsp;&nbsp; total_weight = \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float(sum(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in nodes.itervalues()))<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in nodes.itervalues():<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] = \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parts / total_weight * node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br>&nbsp;&nbsp;&nbsp; part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'H'</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8; font-family: Consolas;">)<br>&nbsp; </span><a style="border-bottom-style: none;" name="OLE_LINK4"></a><a style="border-bottom-style: none;" name="OLE_LINK3"></a><span style="mso-bookmark: ole_link4;"><span style="color: #f6f3e8; font-family: Consolas;">&nbsp; </span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in nodes.itervalues():<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] -= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part2node.append(node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'id'</span></span></em></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">else</span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in nodes.itervalues():<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] -= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part2node.append(node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'id'</span></span></em></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">])<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; shuffle(part2node)<br>&nbsp;&nbsp;&nbsp; ring = Ring(nodes, part2node, replicas)<br>&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02fs to build ring'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (time() - begin)<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">return</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ring</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">test_ring</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(ring):<br>&nbsp;&nbsp;&nbsp; begin = time()<br>&nbsp;&nbsp;&nbsp; DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">10000000</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; node_counts = {}<br>&nbsp;&nbsp;&nbsp; zone_counts = {}<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in ring.get_nodes(data_id):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts[node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] = \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts.get(node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">], </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">) + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_counts[node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'zone'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] = \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_counts.get(node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">], </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">) + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%ds to test ring'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (time() - begin)<br>&nbsp;&nbsp;&nbsp; total_weight = float(sum(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring.nodes.itervalues()))<br>&nbsp;&nbsp;&nbsp; max_over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; max_under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in ring.nodes.itervalues():<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; desired = DATA_ID_COUNT * REPLICAS * \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] / total_weight<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; diff = node_counts[node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] - desired<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> diff &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * diff / desired<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> over &gt; max_over:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_over = over<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">else</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (-diff) / desired<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> under &gt; max_under:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_under = under<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max node over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_over<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max node under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_under<br>&nbsp;&nbsp;&nbsp; max_over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; max_under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> zone in set(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring.nodes.itervalues()):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_weight = sum(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring.nodes.itervalues() </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] == zone)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; desired = DATA_ID_COUNT * REPLICAS * \<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_weight / total_weight<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; diff = zone_counts[zone] - desired<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> diff &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * diff / desired<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> over &gt; max_over:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_over = over<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">else</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (-diff) / desired<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> under &gt; max_under:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_under = under<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max zone over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_over<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max zone under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_under</span><br><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> __name__ == </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'__main__'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br>&nbsp;&nbsp;&nbsp; PARTITION_POWER = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">16</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; REPLICAS = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">3</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">256</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; ZONE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; nodes = {}<br>&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> len(nodes) &lt; NODE_COUNT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> zone &lt; ZONE_COUNT and len(nodes) &lt; NODE_COUNT:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_id = len(nodes)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nodes[node_id] = {</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: node_id, </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: zone,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> + (node_id % </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br><span style="font-family: Consolas;"><span style="color: #f6f3e8;">&nbsp;&nbsp;&nbsp; ring = build_ring(nodes, PARTITION_POWER, REPLICAS)<br>&nbsp;&nbsp;&nbsp; test_ring(ring)</span><br><br></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0.10</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">s to build ring</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">162</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">s to test ring</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">118581</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node,</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.19</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">115537</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.41</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% under</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1878343</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.18</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1870880</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.22</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">每个</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">node</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">上分布的最大波动为</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1.19%</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">1.41%</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">，而</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">上的波动分布在</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">0.22%</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">以下。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong style="mso-bidi-font-weight: normal;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">总结</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">以上就是</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">ring</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的构建原理分析，引入一致性哈希的原因是为了减少由于增加结点导致数据项移动的数量来提高单调性，引入</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的原因是为了减少由于节点数过少导致移动过多的数据项、引入</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">replica</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的原因是防止数据单点提高冗余性，引入</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zone</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的原因是为了保证分区容忍性、引入</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">weight</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">的原因是为了保证</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">partition</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">分配的均衡。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">那么Ring的结构是否就此止步了呢，在</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Swift开发人员的博客中</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">提到，只要发现更好的数据映射机制，就将Ring推倒重来，所以未来</span></span><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">Ring</span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">会如何演化，咱们也可以参与其中，促其不断地进化。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">致谢</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">本文为<span>学习笔记，</span>写于</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">SAE</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">实习期间，代码分析来自gholt的swift开发博文，一致性哈希图片来自于<span><span><span>sparkliang的博文</span></span></span>，也</span></span></span></span><span style="font-size: 12pt;"><span style="color: #000000;"><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;">感谢</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;">zzcase</span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">在邮件讨论中给予我的诸多帮助</span></span></span></span><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: &#39;Times New Roman&#39;; mso-hansi-font-family: &#39;Times New Roman&#39;;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">参考文章</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://tlohg.com/building-a-consistent-hashing-ring-part-1"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://tlohg.com/building-a-consistent-hashing-ring-part-1</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://blog.csdn.net/zzcase/article/details/6709961"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://blog.csdn.net/zzcase/article/details/6709961</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://blog.csdn.net/sparkliang/article/details/5279393"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://blog.csdn.net/sparkliang/article/details/5279393</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://blog.csdn.net/x15594/article/details/6270242"><span><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #800080;"><span style="text-decoration: underline;">http://blog.csdn.net/x15594/article/details/6270242</span></span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://ultimatearchitecture.net/index.php/2010/06/22/quorum-nwr/"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://ultimatearchitecture.net/index.php/2010/06/22/quorum-nwr/</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://ultimatearchitecture.net/index.php/2010/06/22/consistent_hash_algorithn/"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://ultimatearchitecture.net/index.php/2010/06/22/consistent_hash_algorithn/</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://ultimatearchitecture.net/index.php/2010/06/22/eventually_consistency_base-vs-acid/"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://ultimatearchitecture.net/index.php/2010/06/22/eventually_consistency_base-vs-acid/</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span><a style="border-bottom-style: none;" href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.23.3738"><span style="color: #0000ff; font-family: &#39;Times New Roman&#39;;"><span style="text-decoration: underline;"><span style="font-size: 12pt;">http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.23.3738</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: &#39;Times New Roman&#39;;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p></div><div id="MySignature"><br>
<br>
<p><span style="font-family: 幼圆; color: #000000; font-size: 14px;">---</span><span style="font-family: Comic Sans MS; color: #000000; font-size: 14px">我是低调的不显眼的简洁的不会被敌人发现的分割</span><span style="font-family: 幼圆; color: #000000; font-size: 14px">线---</span></p>
<!-- JiaThis 代码 -->
<div id="jiathis_style_32x32">
<a class="jiathis_button_tsina" title="分享到新浪微博"><span class="jiathis_txt jtico jtico_tsina"></span></a>
<a class="jiathis_button_tqq" title="分享到腾讯微博"><span class="jiathis_txt jtico jtico_tqq"></span></a>
<a class="jiathis_button_renren" title="分享到人人网"><span class="jiathis_txt jtico jtico_renren"></span></a>
<a class="jiathis_button_kaixin001" title="分享到开心网"><span class="jiathis_txt jtico jtico_kaixin001"></span></a>
<a class="jiathis_button_douban" title="分享到豆瓣"><span class="jiathis_txt jtico jtico_douban"></span></a>
<a class="jiathis_button_hi" title="分享到百度空间"><span class="jiathis_txt jtico jtico_hi"></span></a>
<a class="jiathis_button_fanfou" title="分享到饭否"><span class="jiathis_txt jtico jtico_fanfou"></span></a>
<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
<a class="jiathis_counter_style"><span class="jiathis_button_expanded jiathis_counter jiathis_bubble_style" id="jiathis_counter_48" title="累计分享8次">8</span></a>
</div>
<div style="position:absolute;width:0px;height:0px;"><object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="0" height="0" id="JIATHISSWF" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab"><param name="allowScriptAccess" value="always"><param name="swLiveConnect" value="true"><param name="movie" value="http://www.jiathis.com/code/swf/m.swf"><param name="FlashVars" value="z=a"><embed name="JIATHISSWF" src="http://www.jiathis.com/code/swf/m.swf" flashvars="z=a" width="0" height="0" allowscriptaccess="always" swliveconnect="true" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer"></object></div><!-- JiaThis Button END -->
<br>
<!-- 自定义代码 -->
<br>
<div style="background-color: #a2dcea;">
<p><span style="font-family: Georgia; color: #000000; font-size: 12pt">&nbsp;&nbsp;&nbsp;&nbsp; This </span><span style="font-family: Georgia; color: #ff6600; font-size: 12pt">article</span><span style="font-family: Georgia; color: #ff0000; font-size: 12pt"> Powered </span><span style="font-family: Georgia; color: #008000; font-size: 12pt">by </span><strong><span style="font-family: Georgia; color: #0000ff; font-size: 12pt">努力</span><span style="font-family: Georgia; color: #0000ff; font-size: 12pt">的</span><span style="color: #808080; font-size: 12pt">牛皮</span><span style="color: #808080; font-size: 12pt">糖</span></strong><span></span></p>
<div><strong><span style="color: #00ccff;"><span style="font-family: 宋体;"><span style="color: #0000ff;"><span style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px;"><span style="line-height: 21px; font-family: Comic Sans MS; color: #0000ff; font-size: 10pt">&nbsp;&nbsp; &nbsp; 新手上路，不恰之处，恳请指出，不胜感谢</span></span></span></span></span></strong></div>
<p><strong><span style="color: #00ccff"><span style="font-family: 宋体"><span style="font-family: Comic Sans MS; color: #0000ff; font-size: 10pt">&nbsp;&nbsp; 转载请注明出处</span><span style="font-family: Comic Sans MS; color: #0000ff; font-size: 10pt">“</span><span style="color: #0000ff"><a href="http://www.cnblogs.com/yuxc/"><font color="#000000"><span style="font-family: Comic Sans MS; font-size: 10pt">一块努力的牛皮糖</span></font></a></span><span style="font-family: Comic Sans MS; color: #0000ff; font-size: 10pt">”：<a href="http://www.cnblogs.com/yuxc/"><font color="#000000"><span style="font-family: Comic Sans MS; font-size: 10pt">http://www.cnblogs.com/yuxc/</span></font></a></span></span></span></strong></p>
<p><strong><span style="color: #00ccff;"><span style="font-family: 宋体;"><span style="color: #0000ff;"><span style="widows: 2; text-transform: none; text-indent: 0px; border-collapse: separate; font: medium Simsun; white-space: normal; orphans: 2; letter-spacing: normal; color: #000000; word-spacing: 0px;" class="Apple-style-span"><span style="line-height: 21px; font-family: Comic Sans MS; color: #0000ff; font-size: 10pt" class="Apple-style-span"></span></span></span></span></span></strong></p>
</div>
</div>
<script type="text/javascript">
var isLogined = false;
var cb_blogId = 88100;
var cb_entryId = 2558312;
var cb_blogApp = currentBlogApp;
var cb_blogUserGuid = "4e16972c-ba5d-e011-a53f-842b2b196315";
var cb_entryCreatedDate = '2012/6/22 8:50:00';
var enableGoogleAd = true;
var googletag = googletag || {};
googletag.cmd = googletag.cmd || [];
</script>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="blog_post_info"><div id="BlogPostCategory">分类: <a href="http://www.cnblogs.com/yuxc/category/324510.html">Swift云存储</a></div>
<div id="EntryTag">标签: <a href="http://www.cnblogs.com/yuxc/tag/Swift/">Swift</a>, <a href="http://www.cnblogs.com/yuxc/tag/openstack/">openstack</a>, <a href="http://www.cnblogs.com/yuxc/tag/Object%20storage/">Object storage</a>, <a href="http://www.cnblogs.com/yuxc/tag/Ring/">Ring</a></div>
<div id="green_channel">
绿色通道：
<a href="javascript:void(0);" id="green_channel_digg" onclick="DiggIt(cb_entryId,cb_blogId,1);green_channel_success(this,&#39;谢谢推荐！&#39;);">好文要顶</a>
<a id="green_channel_follow" onclick="c_follow();" href="javascript:void(0);">关注我</a>
<a id="green_channel_favorite" onclick="AddToWz(cb_entryId);return false;" href="javascript:void(0);">收藏该文</a><a id="green_channel_contact" href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" target="_blank">与我联系</a>
<a id="green_channel_weibo" href="javascript:void(0);" title="分享至新浪微博" onclick="ShareToTsina()"><img src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/icon_weibo_24.png" alt=""></a>
</div>
<div id="digg_block">
<div id="author_profile">
<div id="author_profile_info" class="author_profile_info">
<a href="http://home.cnblogs.com/u/yuxc/" target="_blank"><img src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/u288756.jpg" class="author_avatar" alt=""></a>
<div id="author_profile_detail" class="author_profile_info">
<a href="http://home.cnblogs.com/u/yuxc/">牛皮糖NewPtone</a><br>
<a href="http://home.cnblogs.com/u/yuxc/followees">关注 - 50</a><br>
<a href="http://home.cnblogs.com/u/yuxc/followers">粉丝 - 98</a>
</div>
</div>
<div class="clear"></div>
<div id="author_profile_honor"></div>
<div id="author_profile_follow">
<a href="javascript:void(0);" onclick="c_follow();return false;">+加关注</a>
</div>
</div>
<div id="div_digg">										
	<div class="diggit" onclick="votePost(cb_entryId,&#39;Digg&#39;)"> 
		<span class="diggnum" id="digg_count">2</span>
	</div>
	<div class="buryit" onclick="votePost(cb_entryId,&#39;Bury&#39;)"> 
		<span class="burynum" id="bury_count">0</span>
	</div>
	<div class="clear"></div>	
	<div class="diggword" id="digg_tips">
    (请您对文章做出评价)
    </div>	
</div>
</div></div>
<div class="clear"></div>
<div id="post_next_prev"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/19/2554692.html" class="p_n_p_prefix">« </a> 上一篇：<a href="http://www.cnblogs.com/yuxc/archive/2012/06/19/2554692.html" title="发布于2012-06-19 19:48">安装lxml相关</a><br><a href="http://www.cnblogs.com/yuxc/archive/2012/06/28/2568584.html" class="p_n_p_prefix">» </a> 下一篇：<a href="http://www.cnblogs.com/yuxc/archive/2012/06/28/2568584.html" title="发布于2012-06-28 18:30">深入云存储系统Swift核心组件：Ring数据结构及构建、重平衡操作</a><br></div>
</div>
<script type="text/javascript">
    //SyntaxHighlighter.config.strings.expandSource = '<span><img src="http://static.cnblogs.com/images/expand-code.gif" alt="" class="expand-code-icon"/>View Code</span>';
    $(function () {  
        loadViewCount(cb_entryId);
        fixPostBodyFormat();
        loadAdUnderPost();
        loadBlogSignature();
        LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
        GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);        
        GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);        
    });
</script>
		</div>
		<div class="postDesc">posted @ <span id="post-date">2012-06-22 08:50</span> <a href="http://www.cnblogs.com/yuxc/">牛皮糖NewPtone</a> 阅读(<span id="post_view_count">4223</span>) 评论(<span id="post_comment_count">23</span>)  <a href="http://www.cnblogs.com/yuxc/admin/EditPosts.aspx?postid=2558312" rel="nofollow">编辑</a> <a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" onclick="AddToWz(2558312);return false;">收藏</a></div>
	</div>
	<script src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/2558312" type="text/javascript"></script>
	
</div><!--end: topics 文章、评论容器-->
<div id="blog-comments-placeholder"><div id="comments_pager_top"></div>
<!--done-->
<div class="feedback_area_title">评论列表</div>
<div class="feedbackNoItems"></div>
	

		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2406260" class="layer">#1楼</a><a name="2406260" id="comment_anchor_2406260"></a>  <span class="comment_date">2012-06-22 10:56</span> <a id="a_comment_author_2406260" href="http://www.cnblogs.com/jqbird/" target="_blank">叶鹏</a> <a href="http://space.cnblogs.com/msg/send/%e5%8f%b6%e9%b9%8f" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2406260" class="blog_comment_body">好文要顶</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2406260,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2406260,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2406260_avatar" style="display:none;">http://pic.cnitblog.com/face/u94489.jpg</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2410291" class="layer">#2楼</a><a name="2410291" id="comment_anchor_2410291"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-06-28 18:28</span> <a id="a_comment_author_2410291" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2410291" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2406260" title="查看所回复的评论">@</a>叶鹏<br>感谢支持~~</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2410291,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2410291,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2410291_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2410309" class="layer">#3楼</a><a name="2410309" id="comment_anchor_2410309"></a>  <span class="comment_date">2012-06-28 19:08</span> <a id="a_comment_author_2410309" href="http://www.cnblogs.com/coldair/" target="_blank">coldair</a> <a href="http://space.cnblogs.com/msg/send/coldair" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2410309" class="blog_comment_body">弱弱问一句，，那些流程图是怎么画的</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2410309,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2410309,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2410309_avatar" style="display:none;">http://pic.cnitblog.com/face/u388911.jpg?id=30233029</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2410353" class="layer">#4楼</a><a name="2410353" id="comment_anchor_2410353"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-06-28 20:21</span> <a id="a_comment_author_2410353" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2410353" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2410309" title="查看所回复的评论">@</a>coldair<br>额，一致性哈希算法的图是引用参考文章中的。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2410353,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2410353,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2410353_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2410358" class="layer">#5楼</a><a name="2410358" id="comment_anchor_2410358"></a>  <span class="comment_date">2012-06-28 20:39</span> <a id="a_comment_author_2410358" href="http://www.cnblogs.com/coldair/" target="_blank">coldair</a> <a href="http://space.cnblogs.com/msg/send/coldair" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2410358" class="blog_comment_body">那请问你知道用什么可以画么。。。<br>感觉真不错</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2410358,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2410358,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2410358_avatar" style="display:none;">http://pic.cnitblog.com/face/u388911.jpg?id=30233029</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2411695" class="layer">#6楼</a><a name="2411695" id="comment_anchor_2411695"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-01 16:31</span> <a id="a_comment_author_2411695" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2411695" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2410358" title="查看所回复的评论">@</a>coldair<br>Visio</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2411695,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2411695,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2411695_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2419468" class="layer">#7楼</a><a name="2419468" id="comment_anchor_2419468"></a>  <span class="comment_date">2012-07-05 23:13</span> <a id="a_comment_author_2419468" href="http://home.cnblogs.com/u/424864/" target="_blank">莲藕人</a> <a href="http://space.cnblogs.com/msg/send/%e8%8e%b2%e8%97%95%e4%ba%ba" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2419468" class="blog_comment_body">在“引入虚拟节点”这一节中，增加一个node，可以使移动的对象数降为0.9%，因为此时只是两个“vnode”之间的部分数据移动；<br>但是当删除一个节点时，是不是移动移动的对象数就为大大增加了？因为被删除节点上的所有的vnode上的对象都要进行移动了。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2419468,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2419468,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2419530" class="layer">#8楼</a><a name="2419530" id="comment_anchor_2419530"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-06 04:34</span> <a id="a_comment_author_2419530" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2419530" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2419468" title="查看所回复的评论">@</a>莲藕人<br>不会的，虚节点和数据项之间的关系是固定的。增删节点只改变虚节点和实际节点之间的关系，而且虚节点数目一般设得比较大，所以改变集群节点数量导致的数据移动不会很多。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2419530,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2419530,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2419530_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2420971" class="layer">#9楼</a><a name="2420971" id="comment_anchor_2420971"></a>  <span class="comment_date">2012-07-07 13:12</span> <a id="a_comment_author_2420971" href="http://home.cnblogs.com/u/424864/" target="_blank">莲藕人</a> <a href="http://space.cnblogs.com/msg/send/%e8%8e%b2%e8%97%95%e4%ba%ba" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2420971" class="blog_comment_body">是的，虚节点和数据项之间的关系是固定的，但也仅仅是“关系”是固定的。数据最终还是要保存在node上，如果一个node被删除了，里面的数据也会被删除，此时某些对象的replica肯定是少了1份，此时应该会导致“复制”发生吧，复制的次数应该为被删除node上的对象数，如果每个node上有100个partition,也就是100个partition的数据吧，这也算是数据移动吧？不知道会不会多？<br>另外，再请教一个问题：swift中account是一个用户对应一个account吗，和用户账户一个概念？如何创建account那？ 谢谢</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2420971,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2420971,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2421045" class="layer">#10楼</a><a name="2421045" id="comment_anchor_2421045"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-07 16:05</span> <a id="a_comment_author_2421045" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2421045" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2420971" title="查看所回复的评论">@</a>莲藕人<br>第一个问题：<br>参照一致性哈希算法的图2和3，原来是数据项和节点存在直接映射关系，一旦增删节点就要改变数据项和节点间的映射关系。<br>引入虚结点后，虚节点和节点间存在直接映射关系，每个虚节点管一个范围的地盘，在地盘上管理着它的小弟：数据项。这样每次增删节点带来的数据移动时，我们只要移动一定数量的虚节点，这其中移动的数据量远远小于普通哈希算法移动的数据量，参见Partition的代码部分。<br>第二个问题：关于Account<br>假如你使用的是Tempauth，你可以看下proxyserver.conf配置文件下的[filter:tempauth]<br>例如：<br>user_system_root = testpass .admin<br> <br>account名称是指system（一般会在前面加上reseller区分认证方式，例如AUTH_system）<br>用户账号是system:root<br>passwd是testpass<br>,admin是指账号权限</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2421045,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2421045,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2421045_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2421139" class="layer">#11楼</a><a name="2421139" id="comment_anchor_2421139"></a>  <span class="comment_date">2012-07-07 18:26</span> <a id="a_comment_author_2421139" href="http://home.cnblogs.com/u/424864/" target="_blank">莲藕人</a> <a href="http://space.cnblogs.com/msg/send/%e8%8e%b2%e8%97%95%e4%ba%ba" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2421139" class="blog_comment_body">多谢啦，第一个问题说得很明白，但account仍然没有明白：（，能说得简单易懂些么？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2421139,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2421139,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2425070" class="layer">#12楼</a><a name="2425070" id="comment_anchor_2425070"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-12 11:43</span> <a id="a_comment_author_2425070" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2425070" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2421139" title="查看所回复的评论">@</a>莲藕人<br>简单说，account就是账号，user是用户，一个account下可以有多个&nbsp;user，由account:user字符串组成了登陆账号名</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2425070,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2425070,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2425070_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2437720" class="layer">#13楼</a><a name="2437720" id="comment_anchor_2437720"></a>  <span class="comment_date">2012-07-30 17:50</span> <a id="a_comment_author_2437720" href="http://home.cnblogs.com/u/402595/" target="_blank">BUYI</a> <a href="http://space.cnblogs.com/msg/send/BUYI" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2437720" class="blog_comment_body">图4下面的这一段：<br><div><div id="highlighter_382970" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">vnodes_to_reassign </code><code class="python keyword">=</code> <code class="python plain">VNODE_COUNT </code><code class="python keyword">/</code> <code class="python plain">NEW_NODE_COUNT</code></div><div class="line number2 index1 alt1"><code class="python keyword">while</code> <code class="python plain">vnodes_to_reassign &gt; </code><code class="python value">0</code><code class="python plain">:</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">node_to_take_from </code><code class="python keyword">in</code> <code class="python functions">xrange</code><code class="python plain">(NODE_COUNT):</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">vnode_id, node_id </code><code class="python keyword">in</code> <code class="python functions">enumerate</code><code class="python plain">(new_vnode2node):</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">node_id </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python plain">node_to_take_from:</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">new_vnode2node[vnode_id] </code><code class="python keyword">=</code> <code class="python plain">new_node_id</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">vnodes_to_reassign </code><code class="python keyword">-</code><code class="python keyword">=</code> <code class="python value">1</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">vnodes_to_reassign &lt;</code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">:</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">break</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">vnodes_to_reassign &lt;</code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">:</code></div><div class="line number11 index10 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">break</code></div></div></td></tr></tbody></table></div></div><br><br>第一个break语句应该立即执行，不用作 if vnodes_to_reassign &lt;= 0: 这个判断吧<br>不知道博主为啥跟<a href="http://www.tlohg.com/page/building_a_consistent_hashing_ring.html" target="_blank">原博客</a>在这里有不一样的地方</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2437720,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2437720,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2438073" class="layer">#14楼</a><a name="2438073" id="comment_anchor_2438073"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-31 10:27</span> <a id="a_comment_author_2438073" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2438073" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2437720" title="查看所回复的评论">@</a>BUYI<br>我仔细看了下，我的代码有问题。因为在重新分配vnode到node时，遍历new_vnode2node列表，只要node_id=node_to_take_from就把这个vnode分配给这个新node，然后就break跳出最近的循环，然后从下个要重分配的node开始。<br>gholt的代码是如下：<br><div><div id="highlighter_10903" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">while</code> <code class="python plain">vnodes_to_reassign &gt; </code><code class="python value">0</code><code class="python plain">:</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">node_to_take_from </code><code class="python keyword">in</code> <code class="python functions">xrange</code><code class="python plain">(NODE_COUNT):</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">for</code> <code class="python plain">vnode_id, node_id </code><code class="python keyword">in</code> <code class="python functions">enumerate</code><code class="python plain">(new_vnode2node):</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">node_id </code><code class="python keyword">=</code><code class="python keyword">=</code> <code class="python plain">node_to_take_from:</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">new_vnode2node[vnode_id] </code><code class="python keyword">=</code> <code class="python plain">new_node_id</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">vnodes_to_reassign </code><code class="python keyword">-</code><code class="python keyword">=</code> <code class="python value">1</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">break</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">vnodes_to_reassign &lt;</code><code class="python keyword">=</code> <code class="python value">0</code><code class="python plain">:</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">break</code></div></div></td></tr></tbody></table></div></div><br><br>而我的代码那么写就相当于从node0上拿走所有要重分配的vnode，然后分配给新node。 for node_to_take_from in xrange(NODE_COUNT)只执行了一次，感谢指正</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2438073,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2438073,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2438073_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2438247" class="layer">#15楼</a><a name="2438247" id="comment_anchor_2438247"></a>  <span class="comment_date">2012-07-31 13:56</span> <a id="a_comment_author_2438247" href="http://home.cnblogs.com/u/402595/" target="_blank">BUYI</a> <a href="http://space.cnblogs.com/msg/send/BUYI" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2438247" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2438073" title="查看所回复的评论">@</a>牛皮糖NewPtone<br>感谢你的回复，我在看swift源码 ，一边学python<br>我运行了你写的代码，最后这段大的里头，test_ring方法这一句<br><div><div id="highlighter_768777" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">node_counts[node[</code><code class="python string">'id'</code><code class="python plain">]] </code><code class="python keyword">=</code> <code class="python plain">\</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">node_counts.get(node[</code><code class="python string">'id'</code><code class="python plain">], </code><code class="python value">0</code><code class="python plain">) </code><code class="python keyword">+</code> <code class="python value">1</code></div></div></td></tr></tbody></table></div></div><br>不会报错吗？就下面这句：<br><div><div id="highlighter_886688" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">TypeError: </code><code class="python functions">list</code> <code class="python plain">indices must be integers, </code><code class="python keyword">not</code> <code class="python functions">str</code></div></div></td></tr></tbody></table></div></div><br>因为node是个 [ { 'id':20, 'zone':10 } ]  这样的list<br>node[0] 才是一个dict<br><br>这代码是什么意思呢？get的是啥。。为啥要加1？</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2438247,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2438247,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2438342" class="layer">#16楼</a><a name="2438342" id="comment_anchor_2438342"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-07-31 15:27</span> <a id="a_comment_author_2438342" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2438342" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2438247" title="查看所回复的评论">@</a>BUYI<br>我运行没有问题，node肯定是个dict，不然前面node['weight']、['id']等等就先报错了。你再试试，新建个文件，把代码复制进去，然后用python -d script.py的方式运行</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2438342,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2438342,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2438342_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2522574" class="layer">#17楼</a><a name="2522574" id="comment_anchor_2522574"></a>  <span class="comment_date">2012-11-02 10:27</span> <a id="a_comment_author_2522574" href="http://home.cnblogs.com/u/463599/" target="_blank">sitanda</a> <a href="http://space.cnblogs.com/msg/send/sitanda" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2522574" class="blog_comment_body">我不明白，当在多个zone中添加多个devices时，还如何保证能在扩容后取到之前所有的数据，因为同一分区的不同副本可能已经失掉了之前的位置</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2522574,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2522574,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2522867" class="layer">#18楼</a><a name="2522867" id="comment_anchor_2522867"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2012-11-02 15:54</span> <a id="a_comment_author_2522867" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2522867" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2522574" title="查看所回复的评论">@</a>sitanda<br>每次添加新的device时，会进行rebalance操作，然后生成新的ring文件，分发到每个存储节点上，存储节点上的进程每30秒检查一次ring文件，发现有变化就加载到内存中，这时它们知道了自己所拥有的数据的新位置，如果需要就会进行迁移，同时proxy在请求数据的时候，也知道了该向哪三台存储节点发出请求。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2522867,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2522867,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2522867_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2678326" class="layer">#19楼</a><a name="2678326" id="comment_anchor_2678326"></a>  <span class="comment_date">2013-05-11 19:21</span> <a id="a_comment_author_2678326" href="http://www.cnblogs.com/fczjuever/" target="_blank">最初的幸福ever</a> <a href="http://space.cnblogs.com/msg/send/%e6%9c%80%e5%88%9d%e7%9a%84%e5%b9%b8%e7%a6%8fever" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2678326" class="blog_comment_body"><div><div id="highlighter_291092" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">while</code> <code class="python plain">part2node[part] </code><code class="python keyword">in</code> <code class="python plain">node_ids </code><code class="python keyword">and</code> <code class="python plain">\</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">node2zone[part2node[part]] </code><code class="python keyword">in</code> <code class="python plain">zones:</code></div><div class="line number3 index2 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">part </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python value">1</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">part &gt; PARTITION_MAX:</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">part </code><code class="python keyword">=</code> <code class="python value">0</code></div></div></td></tr></tbody></table></div></div><br><br>这里是为了跳过那些不合适的partition吧，规则是否应该为：如果这个partition所属的node已经拥有该数据的副本，或者这个partition所属的zone已经拥有该数据的副本，则尝试下一个partition。and是否应该改为or？<br><br><div><div id="highlighter_422805" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python keyword">while</code> <code class="python plain">part2node[part] </code><code class="python keyword">in</code> <code class="python plain">node_ids </code><code class="python keyword">or</code> <code class="python plain">\</code></div><div class="line number2 index1 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">node2zone[part2node[part]] </code><code class="python keyword">in</code> <code class="python plain">zones:</code></div></div></td></tr></tbody></table></div></div></div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2678326,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2678326,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2678326_avatar" style="display:none;">http://pic.cnitblog.com/face/508429/20130324002703.png</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2678331" class="layer">#20楼</a><a name="2678331" id="comment_anchor_2678331"></a>  <span class="comment_date">2013-05-11 19:33</span> <a id="a_comment_author_2678331" href="http://www.cnblogs.com/fczjuever/" target="_blank">最初的幸福ever</a> <a href="http://space.cnblogs.com/msg/send/%e6%9c%80%e5%88%9d%e7%9a%84%e5%b9%b8%e7%a6%8fever" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2678331" class="blog_comment_body"><div><div id="highlighter_552212" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">node_ids </code><code class="python keyword">=</code> <code class="python plain">[</code><code class="python color1">self</code><code class="python plain">.part2node[part]]</code></div><div class="line number2 index1 alt1"><code class="python plain">&lt;b&gt;zones </code><code class="python keyword">=</code> <code class="python plain">[</code><code class="python color1">self</code><code class="python plain">.nodes[node_ids[</code><code class="python value">0</code><code class="python plain">]]]&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt;</code></div><div class="line number3 index2 alt2"><code class="python keyword">for</code> <code class="python plain">replica </code><code class="python keyword">in</code> <code class="python functions">xrange</code><code class="python plain">(</code><code class="python value">1</code><code class="python plain">, </code><code class="python color1">self</code><code class="python plain">.replicas):</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">while</code> <code class="python color1">self</code><code class="python plain">.part2node[part] </code><code class="python keyword">in</code> <code class="python plain">node_ids &lt;b&gt;</code><code class="python keyword">and</code><code class="python plain">&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt; \</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">&lt;b&gt;</code><code class="python color1">self</code><code class="python plain">.nodes[</code><code class="python color1">self</code><code class="python plain">.part2node[part]] </code><code class="python keyword">in</code> <code class="python plain">zones:&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt;</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">part </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python value">1</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">part &gt;</code><code class="python keyword">=</code> <code class="python functions">len</code><code class="python plain">(</code><code class="python color1">self</code><code class="python plain">.part2node):</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">part </code><code class="python keyword">=</code> <code class="python value">0</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">node_ids.append(</code><code class="python color1">self</code><code class="python plain">.part2node[part])</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">&lt;b&gt;zones.append(</code><code class="python color1">self</code><code class="python plain">.nodes[node_ids[</code><code class="python keyword">-</code><code class="python value">1</code><code class="python plain">]])&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt;</code></div></div></td></tr></tbody></table></div></div><br><br>zones = [self.nodes[node_ids[0]]]的结果是[{'id': node_id, 'zone': zone, 'weight': weight}]，而此处应该是要获得zone的id吧，不同的{'id': node_id, 'zone': zone, 'weight': weight}可能会对应于同一个zone。代码是否应改为：<br><br><div><div id="highlighter_277265" class="syntaxhighlighter  python"><div class="toolbar"><span><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" class="toolbar_item command_help help">?</a></span></div><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="python plain">node_ids </code><code class="python keyword">=</code> <code class="python plain">[</code><code class="python color1">self</code><code class="python plain">.part2node[part]]</code></div><div class="line number2 index1 alt1"><code class="python plain">&lt;b&gt;zones </code><code class="python keyword">=</code> <code class="python plain">[</code><code class="python color1">self</code><code class="python plain">.nodes[node_ids[</code><code class="python value">0</code><code class="python plain">]][</code><code class="python string">'zone'</code><code class="python plain">]]&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt;</code></div><div class="line number3 index2 alt2"><code class="python keyword">for</code> <code class="python plain">replica </code><code class="python keyword">in</code> <code class="python functions">xrange</code><code class="python plain">(</code><code class="python value">1</code><code class="python plain">, </code><code class="python color1">self</code><code class="python plain">.replicas):</code></div><div class="line number4 index3 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">while</code> <code class="python color1">self</code><code class="python plain">.part2node[part] </code><code class="python keyword">in</code> <code class="python plain">node_ids &lt;b&gt;</code><code class="python keyword">or</code><code class="python plain">&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt; \</code></div><div class="line number5 index4 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">&lt;b&gt;</code><code class="python color1">self</code><code class="python plain">.nodes[</code><code class="python color1">self</code><code class="python plain">.part2node[part]][</code><code class="python string">'zone'</code><code class="python plain">] </code><code class="python keyword">in</code> <code class="python plain">zones:&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt;</code></div><div class="line number6 index5 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">part </code><code class="python keyword">+</code><code class="python keyword">=</code> <code class="python value">1</code></div><div class="line number7 index6 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python keyword">if</code> <code class="python plain">part &gt;</code><code class="python keyword">=</code> <code class="python functions">len</code><code class="python plain">(</code><code class="python color1">self</code><code class="python plain">.part2node):</code></div><div class="line number8 index7 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">part </code><code class="python keyword">=</code> <code class="python value">0</code></div><div class="line number9 index8 alt2"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">node_ids.append(</code><code class="python color1">self</code><code class="python plain">.part2node[part])</code></div><div class="line number10 index9 alt1"><code class="python spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="python plain">&lt;b&gt;zones.append(</code><code class="python color1">self</code><code class="python plain">.nodes[node_ids[</code><code class="python keyword">-</code><code class="python value">1</code><code class="python plain">]][</code><code class="python string">'zone'</code><code class="python plain">])&lt;</code><code class="python keyword">/</code><code class="python plain">b&gt;</code></div></div></td></tr></tbody></table></div></div></div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2678331,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2678331,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2678331_avatar" style="display:none;">http://pic.cnitblog.com/face/508429/20130324002703.png</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2696938" class="layer">#21楼</a><a name="2696938" id="comment_anchor_2696938"></a>  <span class="comment_date">2013-06-03 19:34</span> <a id="a_comment_author_2696938" href="http://www.cnblogs.com/lizhe88/" target="_blank">IntoTheRain</a> <a href="http://space.cnblogs.com/msg/send/IntoTheRain" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2696938" class="blog_comment_body">首先楼主你这篇表明原创,结果大部分抄袭,抄袭原文不在标题文章之前给出, 这就很违背博客原则.<br>其次看看虚拟节点的引入那部分<br>---考虑到哈希算法并不是保证绝对的平衡，尤其node较少的话，对象并不能被均匀的映射到 node上。为了解决这种情况，一致性哈希引入了“虚拟节点”的概念---<br><br>我不怀疑楼主现在弄清了分布式哈希原则,但是你在写作时,真的弄清楚了原理吗,上面这段话明显就是一种误读. 同时在gholt英文中已经明确讲明了原因.<br>Okay, that is better. But still, moving 50% of our data to add 1% capacity is not very good. If we examine what happened more closely we'll see what is an "accordion effect". We shrunk node 0's range a bit to give to the new node, but that shifted all the other node's ranges by the same amount.<br>而楼主却要另加解释,还是个错误的!</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2696938,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2696938,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2696999" class="layer">#22楼</a><a name="2696999" id="comment_anchor_2696999"></a>[<span class="louzhu">楼主</span>]  <span class="comment_date">2013-06-03 21:30</span> <a id="a_comment_author_2696999" href="http://www.cnblogs.com/yuxc/" target="_blank">牛皮糖NewPtone</a> <a href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2696999" class="blog_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2696938" title="查看所回复的评论">@</a>IntoTheRain<br>我在致谢里添加了详细说明，以杜绝抄袭之嫌。<br>另外感谢指出我的错误，关于虚拟节点的说明，已经更正。</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2696999,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2696999,&#39;Bury&#39;,this)">反对(0)</a></div><span id="comment_2696999_avatar" style="display:none;">http://pic.cnitblog.com/face/u288756.jpg?id=05165748</span>
			</div>
		</div>
	
		<div class="feedbackItem">
			<div class="feedbackListSubtitle">
				<div class="feedbackManage">
					&nbsp;&nbsp;<span class="comment_actions"></span>
				</div>
				<a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2720594" class="layer">#23楼</a><a name="2720594" id="comment_anchor_2720594"></a><span id="comment-maxId" style="display:none;">2720594</span><span id="comment-maxDate" style="display:none;">2013/7/5 9:52:27</span>  <span class="comment_date">2013-07-05 09:52</span> <a id="a_comment_author_2720594" href="http://www.cnblogs.com/chllovegeyuting/" target="_blank">SA高处不胜寒</a> <a href="http://space.cnblogs.com/msg/send/SA%e9%ab%98%e5%a4%84%e4%b8%8d%e8%83%9c%e5%af%92" title="发送站内短消息" class="sendMsg2This">&nbsp;</a>
			</div>
			<div class="feedbackCon">
				<div id="comment_body_2720594" class="blog_comment_body">你好，首先谢谢作者能写这么好的博文让我们学习，我有一点不太明白<br>博文中有这样一段， “所以在设置虚结点数的时候，需要对系统预期的规模做充分考虑，假如集群的规模不会超过6000个结点，那么可以将虚结点数设置为结点数的100倍。这样，变动任意一个结点的负载仅影响1%的数据项。此时有6百万个vnode数，使用2bytes来存储结点数(0~65535)。基本的内存占用是6*106*2bytes=12Mb，”<br>此时节点数是6000个 你可以用2bytes进行存储，但是你的虚拟节点数2bytes应该远远不够的啊 因为它是6百万个，2bytes也就0~65535<br><br>谢谢</div><div class="comment_vote"><a href="javascript:void(0);" class="comment_digg" onclick="return voteComment(2720594,&#39;Digg&#39;,this)">支持(0)</a><a href="javascript:void(0);" class="comment_bury" onclick="return voteComment(2720594,&#39;Bury&#39;,this)">反对(0)</a></div>
			</div>
		</div>
	<div id="comments_pager_bottom"></div></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();">刷新评论</a><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#" onclick="return RefreshPage();">刷新页面</a><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#top">返回顶部</a></div>
<div id="comment_form_container"><div class="login_tips">注册用户登录后才能发表评论，请 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return login(&#39;commentform&#39;);">登录</a> 或 <a rel="nofollow" href="javascript:void(0);" class="underline" onclick="return register();">注册</a>，<a href="http://www.cnblogs.com/">访问</a>网站首页。</div></div>

<script type="text/javascript">
    if (typeof commentManager === 'undefined') {
        commentManager = new blogCommentManager();
    }
    commentManager.loadCommentForm();   
</script>

<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="site_nav_under"><a href="http://www.cnblogs.com/" target="_blank" title="程序员的网上家园">博客园首页</a><a href="http://q.cnblogs.com/" target="_blank" title="程序员问答社区">博问</a><a href="http://news.cnblogs.com/" target="_blank" title="IT新闻">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></div>
<div id="ad_under_post_holder">
<div id="google_ad_c1" class="c_ad_block">
    <!-- cnblogs_blogpost_C1_sitehome -->
    <div id="div-gpt-ad-1346480159711-0" style="width:300px; height:250px;">
    
    <iframe id="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0" name="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0" width="300" height="250" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" src="javascript:"<html><body style='background:transparent'></body></html>"" style="border: 0px; vertical-align: bottom;"></iframe><iframe id="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0__hidden__" name="google_ads_iframe_/1090369/cnblogs_blogpost_C1_sitehome_0__hidden__" width="0" height="0" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" src="javascript:"<html><body style='background:transparent'></body></html>"" style="border: 0px; vertical-align: bottom; visibility: hidden; display: none;"></iframe></div>
</div>
<div id="blog_news_kb"><div class="itnews c_ad_block"><b>最新IT新闻</b>:<br> ·  <a href="http://news.cnblogs.com/n/182345/" target="_blank">果冻豆迅速普及难解决Android碎片化问题</a><br> ·  <a href="http://news.cnblogs.com/n/182344/" target="_blank">阿里技术嘉年华7月14日上午场内容</a><br> ·  <a href="http://news.cnblogs.com/n/182343/" target="_blank">德国电信开售阿卡手机 搭载Firefox OS</a><br> ·  <a href="http://news.cnblogs.com/n/182342/" target="_blank">世界级3D设计师拉斐尔•格拉萨蒂访谈录</a><br> ·  <a href="http://news.cnblogs.com/n/182341/" target="_blank">Gartner：三星苹果将继续上演“双雄争霸”</a><br>» <a href="http://news.cnblogs.com/" title="IT新闻" target="_blank">更多新闻...</a></div><div class="itnews c_ad_block" id="kb_block"><b>最新知识库文章</b>:<br><div id="kb_recent"> ·  <a href="http://kb.cnblogs.com/page/182265/" target="_blank">硅谷归来7点分享：创业者，做你自己</a><br> ·  <a href="http://kb.cnblogs.com/page/182200/" target="_blank">我为什么不能坚持？</a><br> ·  <a href="http://kb.cnblogs.com/page/168725/" target="_blank">成为高效程序员的7个重要习惯</a><br> ·  <a href="http://kb.cnblogs.com/page/182047/" target="_blank">谈谈对BPM的理解</a><br> ·  <a href="http://kb.cnblogs.com/page/175976/" target="_blank">编程从业五年的十四条经验，句句朴实</a><br></div>» <a href="http://kb.cnblogs.com/" target="_blank">更多知识库文章...</a></div></div>
<div id="google_ad_c2" class="c_ad_block">
    <!-- cnblogs_blogpost_C2_sitehome -->
    <div id="div-gpt-ad-1346479110744-1" style="width:468px; height:60px;">
    
    <iframe id="google_ads_iframe_/1090369/cnblogs_blogpost_C2_sitehome_0" name="google_ads_iframe_/1090369/cnblogs_blogpost_C2_sitehome_0" width="468" height="60" scrolling="no" marginwidth="0" marginheight="0" frameborder="0" src="javascript:"<html><body style='background:transparent'></body></html>"" style="border: 0px; vertical-align: bottom;"></iframe></div>
</div></div>
<div id="HistoryToday" class="c_ad_block"><b>历史上的今天:</b><br>2011-06-22 <a href="http://www.cnblogs.com/yuxc/archive/2011/06/22/2087537.html">YAML 简介----试图用一种比 XML 更敏捷的方式，来完成 XML 所完成的任务</a><br>2011-06-22 <a href="http://www.cnblogs.com/yuxc/archive/2011/06/22/2087037.html">解决在matplotlib使用中文的问题</a><br></div>
</div>





	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">牛皮糖的Blog</h3>
	<div id="blog-news"><div>
<div><span style="font-family: Comic Sans MS; color: #800080">This is a newbie' Blog...</span><span style="color: #0000ff"><span style="color: #0000ff"><span style="color: #0000ff"><img alt="" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/224027861.gif"></span></span></span></div></div>
<p><span style="font-family: Comic Sans MS; color: #ff6600">Welcome here,If you like...</span><span style="color: #0000ff"><span style="color: #0000ff"><img alt="" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/224026855.gif"></span></span></p><p>&nbsp;</p><p><span style="font-family: &#39;Comic Sans MS&#39;; color: #0000ff; ">You could do something as follows:&nbsp;</span></p><div><ul><li><a href="http://www.cnblogs.com/yuxc/rss" rel="nofollow" target="_blank"><img border="0" alt="订阅我的博客" align="absMiddle" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/feed-icon32x32.png" style="border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; border-bottom-width: medium; border-bottom-color: initial; border-left-width: medium; border-left-color: initial; border-top-width: medium; border-top-color: initial; border-right-width: medium; border-right-color: initial; ">&nbsp;订阅我的博客</a>&nbsp;</li><li><a href="http://weibo.com/nupta" rel="nofollow" target="_blank"><img border="0" alt="" align="absMiddle" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/sina.jpg" style="border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; ">&nbsp;我的新浪微博</a>&nbsp;</li><li><a href="http://www.douban.com/people/Nupta/" target="_blank"><img align="absMiddle" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/douban.jpg" width="32" height="32" border="0" alt="" style="border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; ">&nbsp;我的豆瓣</a>&nbsp;</li><li><a href="http://blog.163.com/yuxcer@126/" target="_blank"><img alt="YuxcBlog" align="absMiddle" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/ava.s" width="32" height="32" border="0" style="border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; ">&nbsp;我的网易博客</a>&nbsp;</li><li><a href="http://www.google.com/reader/view/feed/http://www.cnblogs.com/yuxc/rss" rel="nofollow" target="_blank"><img border="0" alt="通过Google订阅本站" align="absMiddle" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/icon_subshot01_google.gif" style="border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; "></a></li><li><a href="http://www.xianguo.com/subscribe.php?url=http://www.cnblogs.com/yuxc/rss" rel="nofollow" target="_blank"><img border="0" alt="通过鲜果订阅本站" align="absMiddle" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/icon_subshot01_xianguo.gif" style="border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; "></a></li><li><a href="http://www.zhuaxia.com/add_channel.php?url=http://www.cnblogs.com/yuxc/rss" target="_blank"><img border="0" alt="抓虾" vspace="2" align="absMiddle" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/icon_subshot01_zhuaxia.gif" style="border-top-style: none; border-right-style: none; border-bottom-style: none; border-left-style: none; border-width: initial; border-color: initial; margin-bottom: 3px; "></a></li></ul></div><div id="profile_block">昵称：<a href="http://home.cnblogs.com/u/yuxc/">牛皮糖NewPtone</a><br>园龄：<a href="http://home.cnblogs.com/u/yuxc/" title="入园时间：2011-04-03">2年3个月</a><br>粉丝：<a href="http://home.cnblogs.com/u/yuxc/followers/">98</a><br>关注：<a href="http://home.cnblogs.com/u/yuxc/followees/">50</a><div id="p_b_follow"><a href="javascript:void(0);" onclick="cnblogs.UserManager.FollowBlogger(&#39;4e16972c-ba5d-e011-a53f-842b2b196315&#39;)">+加关注</a></div></div></div>
</div>

			<div id="calendar"><div id="blog-calendar" style="displya:none"></div></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn">

<div class="mySearch">
<h3 class="catListTitle">搜索</h3>
<div id="widget_my_zzk" class="div_my_zzk"><input type="text" id="q" onkeydown="return zzk_go_enter(event);" class="input_my_zzk">&nbsp;<input onclick="zzk_go()" type="button" value="找找看" id="btnZzk" class="btn_my_zzk"></div>

</div>


<div class="catListPostCategory">
<h3 class="catListTitle">随笔分类<span style="font-size:11px;font-weight:normal">(218)</span></h3>

<ul>

<li><a id="ctl01_CatList_LinkList_0_Link_0" href="http://www.cnblogs.com/yuxc/category/416768.html">DevOps(6)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_1" href="http://www.cnblogs.com/yuxc/category/359533.html">Linux集市(24)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_2" href="http://www.cnblogs.com/yuxc/category/400759.html">Mac OS(1)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_3" href="http://www.cnblogs.com/yuxc/category/416451.html">OpenStack云计算(7)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_4" href="http://www.cnblogs.com/yuxc/category/296453.html">Project 1：Audio(5)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_5" href="http://www.cnblogs.com/yuxc/category/296463.html">Project 2：Grid(7)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_6" href="http://www.cnblogs.com/yuxc/category/431506.html">Puppet(2)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_7" href="http://www.cnblogs.com/yuxc/category/296461.html">PYMOTW(1)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_8" href="http://www.cnblogs.com/yuxc/category/314865.html">Python美味食谱(9)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_9" href="http://www.cnblogs.com/yuxc/category/307122.html">Python自然语言处理(71)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_10" href="http://www.cnblogs.com/yuxc/category/410887.html">StackOps(3)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_11" href="http://www.cnblogs.com/yuxc/category/324510.html">Swift云存储(18)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_12" href="http://www.cnblogs.com/yuxc/category/296455.html">ThinkPython(7)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_13" href="http://www.cnblogs.com/yuxc/category/493381.html">生活和思考(1)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_14" href="http://www.cnblogs.com/yuxc/category/318339.html">数据库(2)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_15" href="http://www.cnblogs.com/yuxc/category/313480.html">网络编程(4)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_16" href="http://www.cnblogs.com/yuxc/category/307123.html">我在看的书(7)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_17" href="http://www.cnblogs.com/yuxc/category/296458.html">形式化技术(7)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_18" href="http://www.cnblogs.com/yuxc/category/296450.html">有趣的Python(22)</a> </li>

<li><a id="ctl01_CatList_LinkList_0_Link_19" href="http://www.cnblogs.com/yuxc/category/296486.html">杂货铺(14)</a> </li>

</ul>

</div>

<div class="catListPostArchive">
<h3 class="catListTitle">随笔档案<span style="font-size:11px;font-weight:normal">(215)</span></h3>

<ul>

<li><a id="ctl01_CatList_LinkList_1_Link_0" href="http://www.cnblogs.com/yuxc/archive/2013/06.html">2013年6月 (2)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_1" href="http://www.cnblogs.com/yuxc/archive/2013/04.html">2013年4月 (2)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_2" href="http://www.cnblogs.com/yuxc/archive/2013/03.html">2013年3月 (2)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_3" href="http://www.cnblogs.com/yuxc/archive/2013/02.html">2013年2月 (4)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_4" href="http://www.cnblogs.com/yuxc/archive/2012/12.html">2012年12月 (1)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_5" href="http://www.cnblogs.com/yuxc/archive/2012/11.html">2012年11月 (10)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_6" href="http://www.cnblogs.com/yuxc/archive/2012/10.html">2012年10月 (3)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_7" href="http://www.cnblogs.com/yuxc/archive/2012/09.html">2012年9月 (6)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_8" href="http://www.cnblogs.com/yuxc/archive/2012/08.html">2012年8月 (8)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_9" href="http://www.cnblogs.com/yuxc/archive/2012/07.html">2012年7月 (4)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_10" href="http://www.cnblogs.com/yuxc/archive/2012/06.html">2012年6月 (4)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_11" href="http://www.cnblogs.com/yuxc/archive/2012/05.html">2012年5月 (7)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_12" href="http://www.cnblogs.com/yuxc/archive/2012/03.html">2012年3月 (4)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_13" href="http://www.cnblogs.com/yuxc/archive/2012/02.html">2012年2月 (5)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_14" href="http://www.cnblogs.com/yuxc/archive/2012/01.html">2012年1月 (1)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_15" href="http://www.cnblogs.com/yuxc/archive/2011/12.html">2011年12月 (2)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_16" href="http://www.cnblogs.com/yuxc/archive/2011/11.html">2011年11月 (1)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_17" href="http://www.cnblogs.com/yuxc/archive/2011/10.html">2011年10月 (2)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_18" href="http://www.cnblogs.com/yuxc/archive/2011/09.html">2011年9月 (13)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_19" href="http://www.cnblogs.com/yuxc/archive/2011/08.html">2011年8月 (67)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_20" href="http://www.cnblogs.com/yuxc/archive/2011/07.html">2011年7月 (10)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_21" href="http://www.cnblogs.com/yuxc/archive/2011/06.html">2011年6月 (19)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_22" href="http://www.cnblogs.com/yuxc/archive/2011/05.html">2011年5月 (7)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_23" href="http://www.cnblogs.com/yuxc/archive/2011/04.html">2011年4月 (20)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_24" href="http://www.cnblogs.com/yuxc/archive/2011/03.html">2011年3月 (9)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_25" href="http://www.cnblogs.com/yuxc/archive/2009/07.html">2009年7月 (1)</a> </li>

<li><a id="ctl01_CatList_LinkList_1_Link_26" href="http://www.cnblogs.com/yuxc/archive/2008/10.html">2008年10月 (1)</a> </li>

</ul>

</div>


<div class="catListBlogRank">
<h3 class="catListTitle">积分与排名</h3>
<ul>
	<li class="liScore">
		积分 -	92647
	</li>
	<li class="liRank">
		排名 -	1267
	</li>
</ul>
</div>



<div class="catListComment">
<h3 class="catListTitle">最新评论</h3>
	<div id="RecentCommentsBlock"><ul>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/yuxc/archive/2012/07/04/2575536.html#2726683">1. Re:深入云存储系统Swift存储节点：存储实现分析</a></li>
    <li class="recent_comment_body">作者有没有研究过riak，和swift类似的云存储，用erlang编写，apache lisence。有兴趣可以一起讨论。<br><a href="http://basho.com/riak/" target="_blank">http://basho.com/riak/</a></li>
    <li class="recent_comment_author">--IntoTheRain</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2720594">2. Re:深入云存储系统Swift核心组件：Ring实现原理剖析</a></li>
    <li class="recent_comment_body">你好，首先谢谢作者能写这么好的博文让我们学习，我有一点不太明白博文中有这样一段， “所以在设置虚结点数的时候，需要对系统预期的规模做充分考虑，假如集群的规模不会超过6000个结点，那么可以将虚结点数设置为结点数的100倍。这样，变动任意一个结点的负载仅影响1%的数据项。此时有6百万个vnode数，使用2bytes来存储结点数(0~65535)。基本的内存占用是6*106*2bytes=12Mb，”...</li>
    <li class="recent_comment_author">--SA高处不胜寒</li>
    <li class="recent_comment_title"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2696999">3. Re:深入云存储系统Swift核心组件：Ring实现原理剖析</a></li>
    <li class="recent_comment_body"><a href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html#2696938" title="查看所回复的评论">@</a>IntoTheRain<br>我在致谢里添加了详细说明，以杜绝抄袭之嫌。<br>另外感谢指出我的错误，关于虚拟节点的说明，已经更正。</li>
    <li class="recent_comment_author">--牛皮糖NewPtone</li>
</ul>
</div>
</div>
</div>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright ©2013 牛皮糖NewPtone
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
<script type="text/javascript" src="./深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园_files/google-analytics.js"></script>


</body></html>